# תרשים זרימה - אלגוריתם סידור ישיבה אוטומטי

## סקירה כללית

```
┌─────────────────────────────────────────────────────────────────┐
│                    buildAutoSeating()                            │
│              הפונקציה הראשית לסידור ישיבה                        │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
```

## שלב 1: טעינת הגדרות וקאש

```
┌─────────────────────────────────────────────────────────────────┐
│  1. טעינת הגדרות החתונה (Wedding Settings)                      │
│     ├── seatsPerTable (מקומות לשולחן, ברירת מחדל: 12)           │
│     ├── adjacencyPolicy (מדיניות שכנות)                         │
│     ├── enableKidsTable (האם להפעיל שולחן ילדים)                │
│     ├── kidsTableMinCount (מינימום ילדים לשולחן, ברירת מחדל: 6) │
│     ├── avoidSinglesAlone (למנוע בודדים לבד בשולחן זוגות)       │
│     └── enableZonePlacement (שיבוץ לפי אזורים)                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. אתחול קאש (initializeCache)                                 │
│     טעינה מקבילית מהדאטאבייס:                                   │
│     ├── tables - כל השולחנות                                    │
│     ├── assignments - כל השיבוצים הקיימים                       │
│     ├── preferences - העדפות "ביחד" ו"בנפרד"                    │
│     ├── adjacencies - שכנויות בין שולחנות                       │
│     ├── groups - קבוצות אורחים                                  │
│     ├── guests - כל האורחים                                     │
│     └── groupPriorities - סדרי עדיפות קבוצות                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
```

## שלב 2: סינון אורחים

```
┌─────────────────────────────────────────────────────────────────┐
│  3. קבלת אורחים פעילים (getActiveGuests)                        │
│                                                                  │
│     מצב "real":      rsvpStatus = 'confirmed'                   │
│     מצב "simulation": rsvpStatus IN ('confirmed', 'pending')    │
│                                                                  │
│     לכל אורח מחושב seatsCount:                                  │
│     ├── real: adultsAttending + childrenAttending               │
│     └── simulation: expectedPartySize או invitedCount           │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. הפרדת אורחים נעולים וחופשיים                                │
│                                                                  │
│     אורח נחשב "נעול" אם:                                        │
│     ├── יש לו lockedSeat = true                                 │
│     ├── יש לו lockedTableId מוגדר                               │
│     └── הוא כבר משובץ בשולחן נעול (locked = true)               │
│                                                                  │
│     ┌──────────────┐         ┌──────────────┐                   │
│     │ lockedGuests │         │  freeGuests  │                   │
│     │ (לא לשבץ)    │         │ (לשיבוץ)     │                   │
│     └──────────────┘         └──────────────┘                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
```

## שלב 3: ניקוי שיבוצים קיימים

```
┌─────────────────────────────────────────────────────────────────┐
│  5. ניקוי שיבוצים משולחנות לא נעולים                            │
│                                                                  │
│     ├── מחיקת SeatAssignment מכל שולחן לא נעול                  │
│     │   (למעט אורחים נעולים)                                    │
│     │                                                            │
│     ├── ניקוי assignedGuests מכל שולחן לא נעול                  │
│     │   (למעט אורחים נעולים)                                    │
│     │                                                            │
│     └── עדכון הקאש בהתאם                                        │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
```

## שלב 4: שולחן ילדים (אופציונלי)

```
┌─────────────────────────────────────────────────────────────────┐
│  6. לוגיקת שולחן ילדים                                          │
│                                                                  │
│     ┌────────────────────────┐                                  │
│     │ enableKidsTable = true?│                                  │
│     └───────────┬────────────┘                                  │
│                 │                                                │
│           ┌─────▼─────┐                                         │
│           │ ספור ילדים │                                         │
│           │ מכל האורחים│                                         │
│           └─────┬─────┘                                         │
│                 │                                                │
│     ┌───────────▼───────────┐                                   │
│     │ totalKids >= minCount?│                                   │
│     └───────────┬───────────┘                                   │
│           כן    │    לא                                         │
│     ┌───────────▼───┐  │                                        │
│     │ צור/מצא שולחן │  │                                        │
│     │ ילדים         │  │                                        │
│     └───────────────┘  │                                        │
│                        ▼                                        │
│              ללא שולחן ילדים                                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
```

## שלב 5: קיבוץ אורחים

```
┌─────────────────────────────────────────────────────────────────┐
│  7. קיבוץ אורחים לפי קבוצות                                     │
│                                                                  │
│     לכל אורח חופשי:                                             │
│     ┌──────────────────────────────────────────────┐            │
│     │ יש groupId?                                  │            │
│     │   כן → groupKey = "group:{groupId}"          │            │
│     │   לא → יש familyGroup?                       │            │
│     │         כן → groupKey = "family:{familyGroup}"│            │
│     │         לא → groupKey = "none"               │            │
│     └──────────────────────────────────────────────┘            │
│                                                                  │
│     תוצאה: guestsByGroup (מפה של קבוצה → אורחים)                │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  8. מיון קבוצות לפי עדיפות                                      │
│                                                                  │
│     1. קבוצות עם priority מוגדר (לפי מספר: 1, 2, 3...)          │
│     2. קבוצות ללא priority (לפי א-ב)                            │
│     3. קבוצת "none" (אורחים ללא קבוצה) - אחרונה                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
```

## שלב 6: מיפוי שולחנות קיימים

```
┌─────────────────────────────────────────────────────────────────┐
│  9. מיפוי שולחנות קיימים לקבוצות                                │
│                                                                  │
│     לכל שולחן קיים:                                             │
│     ┌──────────────────────────────────────────────┐            │
│     │ יש groupId?                                  │            │
│     │   כן → מפה לקבוצה המתאימה                    │            │
│     │   לא → שם השולחן מתחיל בשם קבוצה?            │            │
│     │         כן → מפה לקבוצה                      │            │
│     │         לא → שם מתחיל ב"שולחן"?              │            │
│     │               כן → מפה ל"none"               │            │
│     │               לא → לא ממופה                  │            │
│     └──────────────────────────────────────────────┘            │
│                                                                  │
│     חריג: שולחן ילדים (tableType='kids') לא ממופה לשום קבוצה    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
```

## שלב 7: מספור מחדש (אופציונלי)

```
┌─────────────────────────────────────────────────────────────────┐
│  10. מספור שולחנות מחדש (אם יש עדיפויות קבוצות)                │
│                                                                  │
│      יש groupPriorities?                                        │
│      ┌─────┴─────┐                                              │
│      │           │                                              │
│      ▼           ▼                                              │
│     כן          לא → דלג                                        │
│      │                                                          │
│      ▼                                                          │
│     1. איסוף כל השולחנות הלא נעולים                             │
│     2. סידור לפי עדיפות קבוצה                                   │
│     3. העברה למספרים שליליים (זמני)                             │
│     4. הקצאת מספרים סופיים (דילוג על נעולים)                    │
│                                                                  │
│     דוגמה:                                                      │
│     ├── קבוצה א (priority=1) → שולחנות 1, 2                     │
│     ├── קבוצה ב (priority=2) → שולחנות 3, 4                     │
│     ├── שולחן נעול → נשאר במספר המקורי                          │
│     └── קבוצות ללא עדיפות → בסוף                                │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
```

## שלב 8: שיבוץ ילדים (אם יש שולחן ילדים)

```
┌─────────────────────────────────────────────────────────────────┐
│  11. שיבוץ ילדים לשולחן ילדים                                   │
│                                                                  │
│      יש kidsTableId?                                            │
│      ┌─────┴─────┐                                              │
│      │           │                                              │
│      ▼           ▼                                              │
│     כן          לא → דלג                                        │
│      │                                                          │
│      ▼                                                          │
│     לכל אורח עם ילדים:                                          │
│     ├── בדוק מקום פנוי בשולחן ילדים                             │
│     ├── שבץ את הילדים (childrenAttending)                       │
│     └── הפחת מ-seatsCount של האורח (נשארים רק מבוגרים)          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
```

## שלב 9: שיבוץ אורחים ראשי

```
┌─────────────────────────────────────────────────────────────────┐
│  12. לולאת שיבוץ ראשית                                          │
│                                                                  │
│      לכל קבוצה (לפי סדר עדיפות):                                │
│      └── לכל אורח בקבוצה (לפי תאריך הוספה):                     │
│          └── placeSeatsForGuestInFamilyGroup()                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
```

## פונקציית השיבוץ: placeSeatsForGuestInFamilyGroup

```
┌─────────────────────────────────────────────────────────────────┐
│  placeSeatsForGuestInFamilyGroup()                              │
│                                                                  │
│  קלט:                                                           │
│  ├── groupKey - מזהה הקבוצה                                     │
│  ├── guestUnit - פרטי האורח + מספר מקומות                       │
│  ├── seatsPerTable - קיבולת שולחן                               │
│  └── הגדרות נוספות (adjacencyPolicy, avoidSinglesAlone, etc.)  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  while (seatsNeeded > 0):                                       │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ 1. מצא שולחנות עם מקום פנוי מהקבוצה                         ││
│  │                                                              ││
│  │    לכל שולחן בקבוצה:                                        ││
│  │    ├── חשב מקומות פנויים                                    ││
│  │    ├── בדוק canPlaceGuestAtTable()                          ││
│  │    └── חשב ציון (scorePlacement)                            ││
│  └─────────────────────────────────────────────────────────────┘│
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ 2. מיון שולחנות מתאימים                                     ││
│  │                                                              ││
│  │    עדיפות:                                                  ││
│  │    1. התאמת אזור (zone) - אם enableZonePlacement            ││
│  │    2. מספר שולחן נמוך (למלא קודם)                           ││
│  │    3. ציון "ביחד" (together preferences)                    ││
│  └─────────────────────────────────────────────────────────────┘│
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ 3. יש שולחן מתאים?                                          ││
│  │    ┌─────┴─────┐                                            ││
│  │    │           │                                            ││
│  │    ▼           ▼                                            ││
│  │   כן          לא                                            ││
│  │    │           │                                            ││
│  │    │           ▼                                            ││
│  │    │     צור שולחן חדש לקבוצה                               ││
│  │    │     (ליד שולחנות הקבוצה הקיימים)                       ││
│  │    │           │                                            ││
│  │    └─────┬─────┘                                            ││
│  │          ▼                                                  ││
│  │    4. שבץ מקומות                                            ││
│  │       seatsToPlace = min(freeSeats, seatsNeeded)            ││
│  │       ├── הוסף ל-pendingAssignments                         ││
│  │       ├── עדכן קאש                                          ││
│  │       └── seatsNeeded -= seatsToPlace                       ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  הערה: אם האורח גדול מקיבולת שולחן, הוא מפוצל                   │
│        בין מספר שולחנות (split assignment)                      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
```

## בדיקת התאמה: canPlaceGuestAtTableFromCache

```
┌─────────────────────────────────────────────────────────────────┐
│  canPlaceGuestAtTableFromCache()                                │
│                                                                  │
│  בדיקות לפי סדר:                                                │
│                                                                  │
│  1. שולחן ילדים?                                                │
│     └── אורח ללא ילדים → לא מתאים                               │
│                                                                  │
│  2. avoidSinglesAlone = true?                                   │
│     └── אורח בודד + שולחן "couple heavy" + 0 בודדים קיימים     │
│         → לא מתאים (reason: 'singles_alone')                    │
│                                                                  │
│  3. בדיקת העדפות "בנפרד" (apart):                               │
│     └── לכל העדפה:                                              │
│         ├── האורח השני באותו שולחן? → לא מתאים                  │
│         └── adjacencyPolicy = 'forbidSameAndAdjacent'?          │
│             └── האורח השני בשולחן שכן? → לא מתאים               │
│                                                                  │
│  תוצאה: { canPlace: boolean, conflictWith?: string, reason? }   │
└─────────────────────────────────────────────────────────────────┘
```

## חישוב ציון: scorePlacementFromCache

```
┌─────────────────────────────────────────────────────────────────┐
│  scorePlacementFromCache()                                      │
│                                                                  │
│  לכל העדפת "ביחד" (together) של האורח:                          │
│                                                                  │
│  ├── האורח השני באותו שולחן?                                    │
│  │   └── +100 נקודות (×2 אם strength='must')                    │
│  │                                                              │
│  └── האורח השני בשולחן שכן?                                     │
│      └── +50 נקודות (×2 אם strength='must')                     │
│                                                                  │
│  תוצאה: ציון מספרי (גבוה יותר = עדיף)                           │
└─────────────────────────────────────────────────────────────────┘
```

## שלב 10: שמירה לדאטאבייס

```
┌─────────────────────────────────────────────────────────────────┐
│  13. שמירת השיבוצים                                             │
│                                                                  │
│      ├── SeatAssignment.insertMany(pendingAssignments)          │
│      │   (שמירת כל השיבוצים בפעולה אחת)                         │
│      │                                                          │
│      └── Table.updateMany()                                     │
│          (עדכון assignedGuests בכל שולחן)                       │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  14. החזרת תוצאה                                                │
│                                                                  │
│      {                                                          │
│        success: true/false,                                     │
│        assignmentsCreated: number,                              │
│        tablesCreated: number,                                   │
│        conflicts: SeatingConflict[]                             │
│      }                                                          │
└─────────────────────────────────────────────────────────────────┘
```

## זרימה מקוצרת

```
┌──────────────────────────────────────────────────────────────────────────┐
│                                                                          │
│  1. טען הגדרות + קאש                                                     │
│                 │                                                        │
│                 ▼                                                        │
│  2. סנן אורחים (locked vs free)                                         │
│                 │                                                        │
│                 ▼                                                        │
│  3. נקה שיבוצים קיימים משולחנות לא נעולים                                │
│                 │                                                        │
│                 ▼                                                        │
│  4. [אופציונלי] צור שולחן ילדים                                          │
│                 │                                                        │
│                 ▼                                                        │
│  5. קבץ אורחים לפי קבוצות                                                │
│                 │                                                        │
│                 ▼                                                        │
│  6. מפה שולחנות קיימים לקבוצות                                           │
│                 │                                                        │
│                 ▼                                                        │
│  7. [אופציונלי] מספר שולחנות מחדש לפי עדיפות                             │
│                 │                                                        │
│                 ▼                                                        │
│  8. [אם יש שולחן ילדים] שבץ ילדים                                        │
│                 │                                                        │
│                 ▼                                                        │
│  9. לכל קבוצה → לכל אורח:                                                │
│     └── מצא/צור שולחן מתאים                                              │
│     └── שבץ (אפשר פיצול בין שולחנות)                                     │
│                 │                                                        │
│                 ▼                                                        │
│  10. שמור לדאטאבייס                                                      │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

## מודלים קשורים

```
┌─────────────┐    ┌─────────────┐    ┌─────────────────┐
│   Guest     │    │   Table     │    │ SeatAssignment  │
├─────────────┤    ├─────────────┤    ├─────────────────┤
│ _id         │    │ _id         │    │ guestId         │
│ name        │    │ tableName   │    │ tableId         │
│ familyGroup │───▶│ tableNumber │◀───│ seatsCount      │
│ groupId     │    │ capacity    │    │ assignmentType  │
│ rsvpStatus  │    │ tableType   │    │ (real/simulation│
│ adults...   │    │ mode        │    └─────────────────┘
│ children... │    │ locked      │
│ lockedSeat  │    │ zone        │
│ guestType   │    │ assignedGuests
└─────────────┘    └─────────────┘

┌─────────────────┐    ┌─────────────────┐
│ SeatingPreference│    │ GroupPriority   │
├─────────────────┤    ├─────────────────┤
│ guestAId        │    │ groupName       │
│ guestBId        │    │ priority (1,2..)│
│ type (together/ │    └─────────────────┘
│       apart)    │
│ scope           │
│ strength        │
└─────────────────┘
```
